OAW Codebook	{#main}
=====================
Brief description of tables in the data model and how to get certain pieces of data properly.

----------

Page View Fact
--------------

#####Identity
- `page_view_fact_key`: Primary key
- `page_view_id` : Foreign key to other fact tables. 
- `ophan_visitor_id`: Unique browser ID generated by Ophan.
- `omniture_visitor_id`: Omniture visitor cookie ID (s_vi) grabbed by Ophan.
- `ophan_session_id`: ID generated by Ophan's sessionisation. 
- `ds_session_key`: Foreign key to **ds_session_fact**. Unique for each visit defined by the ETL sessionization code.
- `ds_session_page_number`: The ranking of the pageview in the visit.
- `ds_session_start`: Boolean value that indicates if the pageview is first in the visit.
- `ds_session_exit`: Boolean value that indicates if the pageview is the last in the visit.
- `ds_visitor_session_number`: The visit number for this particular visit in the entire history of the Ophan visitor ID. 
- `ip_address`: IP Address.
- `mvt_id`: Int between 0 and 1 million that is part of MVT binning process.

>**Note**:
`page_view_id`: Occurrences of the same page_view_id appearing for Ophan visitor IDs on different days. Possible duplication. Join on ophan_visitor_id as well if you're using this as foreign key. _(May 2014)_

>`sessions`: Sessionisation is relative to Ophan browser's local time, and may not be accurate. A brief check was conducted that the ETL sessionization closely matches to Ophan's sessionization _(April 2014)_.

#####Status
- `http_status`: HTTP status.
- `visibility_status`: Either `hidden` or `visible`[^vis_stat]. 
[^vis_stat]: `visible` is for most actual pageviews, `hidden` is generally for snapshots (eg. Google News tidbit).

- `page_view_type`: One of the three: `WEB_INITIAL`, `NATIVEAPP_VIEW`[^native_app] and `VIEW`.
  [^native_app]: `NATIVEAPP_VIEW` is specific to pageviews seen on NextGen App.

#####Page Details
- `page_view_timestamp`: Timestamp of pageview in UTC.
- `gu_platform`: Platform shown. Either `ngw` or `r2`.
- `url_query_string`: Complete URL of page viewed. 
- `referral_url`: Complete URL of the referring page (can be a Guardian page).[^ref_url]

[^ref_url]: Due to how things are tracked, bookmarks/typed/new tab all have null referral URL.

- `referral_component`: data_component value of the component that was clicked on to get to this pageview.
- `logged_in_flag`: Boolean value to indicate if user has signed in.

#####Dimension keys
- `referral_key`: Foreign key to **referral_dim** table.
- `identity_key`: Foreign key to **identity_dim** table.
- `crm_key`: Foreign key to **crm_revenue_fact** table.
- `content_key`: Foreign key to **content_dim** table.
- `section_key`: Foreign key to **section_dim** table.
- `email_campaign_key`: Foreign key to **email_campaign_dim** table.
- `date_key`: Foreign key to **date_dim** table.
- `time_key`: Foreign key to **time_dim** table.
- `geo_key`: Foreign key to **geo_dim** table.
- `isp_key`: Foreign key to **isp_dim** table.
- `os_key`: Foreign key to **os_dim** table.
- `browser_key`: Foreign key to **browser_dim** table.
- `device_key`: Foreign key to **device_dim** table.

#####ETL Related
- `etl_source_file_key`: Foreign key to etl_source_file_dim.
- `ua_string`: Raw user agent string.
- `etl_load_timestamp`: Timestamp in UTC of when data was loaded in.


----------


Actions
----------
####  <i class = 'icon-beaker'></i> Find out which MVT bin pageviews are in

    select FACT.*, MVT.id, MVT.variant from page_view_fact FACT
    left join page_view_fact_mvt_lookup LOOKUP
    on
        FACT.page_view_id = LOOKUP.page_view_id
        and
        FACT.ophan_visitor_id = LOOKUP.ophan_visitor_id
    
    left join mvt_dim MVT
    on
        LOOKUP.mvt_key = MVT.mvt_key

#### <i class = 'icon-file'></i> Determine section/section front of page.
    select 
        FACT.*,
        SCDIM.section_name,
        case
            when FACT.url_query_string in 
            (
                'http://www.theguardian.com/uk', 
                'http://www.theguardian.com/us',  
                'http://www.theguardian.com/au'
            ) then  'Network Front'
            when FACT.url_query_string in 
            (
                'http://www.theguardian.com/us/sport',
                'http://www.theguardian.com/uk/sport',
                'http://www.theguardian.com/au/sport',
                'http://www.theguardian.com/us/commentisfree',
                'http://www.theguardian.com/uk/commentisfree',
                'http://www.theguardian.com/au/commentisfree',
                'http://www.theguardian.com/us/culture',
                'http://www.theguardian.com/uk/culture',
                'http://www.theguardian.com/au/culture',
                'http://www.theguardian.com/us/business',
                'http://www.theguardian.com/uk/business',
                'http://www.theguardian.com/au/business',
                'http://www.theguardian.com/us/money',
                'http://www.theguardian.com/uk/money',
                'http://www.theguardian.com/au/money',
                'http://www.theguardian.com/world',
                'http://www.theguardian.com/world/usa',
                http://www.theguardian.com/world/australia,
                'http://www.theguardian.com/uk-news',
                'http://www.theguardian.com/world/europe-news',
                'http://www.theguardian.com/world/americas',
                'http://www.theguardian.com/world/asia',
                'http://www.theguardian.com/world/middleeast',
                'http://www.theguardian.com/world/africa',
                'http://www.theguardian.com/world/australia',
                'http://www.theguardian.com/football',
                'http://www.theguardian.com/football/mls',
                'http://www.theguardian.com/sport/nfl',
                'http://www.theguardian.com/sport/mlb',
                'http://www.theguardian.com/sport/nba',
                'http://www.theguardian.com/sport/nhl',
                'http://www.theguardian.com/technology',
                'http://www.theguardian.com/technology/games',
                'http://www.theguardian.com/stage',
                'http://www.theguardian.com/artanddesign',
                'http://www.theguardian.com/books',
                'http://www.theguardian.com/music',
                'http://www.theguardian.com/tv-and-radio',
                'http://www.theguardian.com/film',
                'http://www.theguardian.com/lifeandstyle',
                'http://www.theguardian.com/lifeandstyle/food-and-drink',
                'http://www.theguardian.com/lifeandstyle/health-and-wellbeing',
                'http://www.theguardian.com/lifeandstyle/love-and-sex',
                'http://www.theguardian.com/lifeandstyle/family',
                'http://www.theguardian.com/lifeandstyle/women',
                'http://www.theguardian.com/lifeandstyle/home-and-garden',
                'http://www.theguardian.com/fashion',
                'http://www.theguardian.com/travel',
                'http://www.theguardian.com/environment',
                'http://www.theguardian.com/business/stock-markets',
                'http://www.theguardian.com/business/companies',
                'http://www.theguardian.com/media'
            ) then 'Section Front'
            else 'Non-Front'
        end as is_front
    from page_view_fact FACT
    inner join section_dim SCDIM
    on
        FACT.section_key = SCDIM.section_key
    

### Table of contents

[TOC]

